<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Racing Hub UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.158.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://unpkg.com/three@0.158.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
        body {
            font-family: 'Roboto', sans-serif;
        }
        @keyframes pulse-slow {
            0%, 100% { transform: scale(1); opacity: 0.1; }
            50% { transform: scale(1.02); opacity: 0.2; }
        }
        @keyframes pulse-slower {
            0%, 100% { transform: scale(1); opacity: 0.05; }
            50% { transform: scale(1.01); opacity: 0.1; }
        }
        .animate-pulse-slow { animation: pulse-slow 8s infinite ease-in-out; }
        .animate-pulse-slower { animation: pulse-slower 12s infinite ease-in-out; }
        @keyframes scroll-left {
            0% { transform: translateX(100vw); }
            100% { transform: translateX(-100%); }
        }
        .animate-scroll-left { animation: scroll-left 15s linear infinite; }
        .modal-backdrop { backdrop-filter: blur(10px); }
        #viewer3d { display: none; }
        @keyframes click-glow {
            0% { box-shadow: 0 0 5px rgba(255, 255, 0, 0.3), 0 0 10px rgba(255, 255, 0, 0.2); }
            50% { box-shadow: 0 0 20px rgba(255, 255, 0, 0.8), 0 0 40px rgba(255, 255, 0, 0.6), 0 0 60px rgba(255, 255, 0, 0.4); }
            100% { box-shadow: 0 0 5px rgba(255, 255, 0, 0.3), 0 0 10px rgba(255, 255, 0, 0.2); }
        }
        .click-glow { animation: click-glow 0.3s ease-out; }
    </style>
</head>
<body class="bg-[#0a1423] m-0 p-0 overflow-hidden">
    <div id="app-root"></div>
    <script>
        // --- STATE MANAGEMENT ---
        let activeBubbleId = null;
        let activeSubBubbleId = null;
        const currentCarImage = 'https://images.unsplash.com/photo-1583121274602-3e2820c69888?q=80&w=800&auto=format&fit=crop';
        const backgroundImage = 'https://images.unsplash.com/photo-1614294103233-6c827c17b830?q=80&w=1200&auto=format&fit=crop';

        // --- DATA ---
        const bubblesData = [
            {
                id: 'market',
                label: 'Market',
                icon: 'ðŸ›’',
                angle: 30,
                distance: 200,
                submodules: [
                    {
                        id: 'used',
                        label: 'Used',
                        icon: 'ðŸ› ï¸',
                        angle: 0,
                        distance: 90,
                        submodules: [
                            { id: 'auction', label: 'Auction', icon: 'âš–ï¸', angle: -45, distance: 70 },
                            { id: 'marketplace', label: 'Marketplace', icon: 'ðŸª', angle: 45, distance: 70 }
                        ]
                    },
                    { id: 'new-cars', label: 'New Cars', icon: 'âœ¨', angle: 120, distance: 90 },
                    { id: 'dealership', label: 'Dealership', icon: 'ðŸ¢', angle: 240, distance: 90 }
                ]
            },

            {
                id: 'race',
                label: 'Race',
                icon: 'ðŸ',
                angle: 66,
                distance: 200,
                submodules: [
                    { id: 'race-quick', label: 'Quick Race', icon: 'ðŸŽï¸', angle: 0, distance: 90 },
                    { id: 'race-champ', label: 'Championship', icon: 'ðŸ†', angle: 72, distance: 90 },
                    { id: 'race-online', label: 'Online', icon: 'ðŸŒ', angle: 144, distance: 90 },
                    { id: 'race-time', label: 'Time Trial', icon: 'â±ï¸', angle: 216, distance: 90 },
                    { id: 'race-drift', label: 'Drift', icon: 'ðŸŒ€', angle: 288, distance: 90 }
                ]
            },

            {
                id: 'career',
                label: 'Career',
                icon: 'ðŸ†',
                angle: 102,
                distance: 200,
                submodules: [
                    { id: 'career-story', label: 'Story Mode', icon: 'ðŸ“–', angle: 0, distance: 90 },
                    { id: 'career-challenges', label: 'Challenges', icon: 'ðŸŽ¯', angle: 120, distance: 90 },
                    { id: 'career-progress', label: 'Progress', icon: 'ðŸ“Š', angle: 240, distance: 90 }
                ]
            },

            {
                id: 'events',
                label: 'Events',
                icon: 'ðŸŽ‰',
                angle: 138,
                distance: 200,
                submodules: [
                    { id: 'events-special', label: 'Special', icon: 'âœ¨', angle: 0, distance: 90 },
                    { id: 'events-community', label: 'Community', icon: 'ðŸ‘¥', angle: 120, distance: 90 },
                    { id: 'events-boards', label: 'Leaderboards', icon: 'ðŸ¥‡', angle: 240, distance: 90 }
                ]
            },

            {
                id: 'options',
                label: 'Options',
                icon: 'âš™ï¸',
                angle: 174,
                distance: 200,
                submodules: [
                    { id: 'options-graphics', label: 'Graphics', icon: 'ðŸ–¥ï¸', angle: 0, distance: 90 },
                    { id: 'options-audio', label: 'Audio', icon: 'ðŸ”Š', angle: 90, distance: 90 },
                    { id: 'options-controls', label: 'Controls', icon: 'ðŸŽ®', angle: 180, distance: 90 },
                    { id: 'options-gameplay', label: 'Gameplay', icon: 'ðŸŽ²', angle: 270, distance: 90 }
                ]
            },

            {
                id: 'tune',
                label: 'Tune',
                icon: 'ðŸ› ï¸',
                angle: 210,
                distance: 200,
                submodules: [
                    { id: 'tune-engine', label: 'Engine', icon: 'âš™ï¸', angle: 0, distance: 90 },
                    { id: 'tune-suspension', label: 'Suspension', icon: 'ðŸ”©', angle: 90, distance: 90 },
                    { id: 'tune-tires', label: 'Tires', icon: 'âš«', angle: 180, distance: 90 },
                    { id: 'tune-ecu', label: 'ECU', icon: 'ðŸ’»', angle: 270, distance: 90 }
                ]
            },

            {
                id: 'garage',
                label: 'Garage',
                icon: 'ðŸš—',
                angle: 246,
                distance: 200,
                submodules: [
                    { id: 'paint', label: 'Paint', icon: 'ðŸŽ¨', angle: 0, distance: 90 },
                    { id: 'edit-parts', label: 'Edit Parts', icon: 'ðŸ”§', angle: 60, distance: 90 },
                    { id: 'parts', label: 'Parts', icon: 'ðŸ”©', angle: 120, distance: 90 },
                    { id: '3d-viewer', label: '3D Viewer', icon: 'ðŸ“¦', angle: 180, distance: 90 },
                    { id: 'view-all', label: 'All Cars', icon: 'ðŸŽï¸', angle: 240, distance: 90 },
                    { id: 'view-specific', label: 'Inspect', icon: 'ðŸ”', angle: 300, distance: 90 }
                ]
            },
            {
                id: 'social',
                label: 'Social',
                icon: 'ðŸŒ',
                angle: 282,
                distance: 200,
                submodules: [
                    { id: 'profile', label: 'My Profile', icon: 'ðŸ‘¤', angle: 0, distance: 90 },
                    { id: 'search', label: 'Search', icon: 'ðŸ”', angle: 72, distance: 90 },
                    { id: 'friends', label: 'Friends', icon: 'ðŸ‘¥', angle: 144, distance: 90 },
                    { id: 'facebook-group', label: 'AI Auto Art', icon: 'ðŸ“˜', angle: 216, distance: 90, url: 'https://www.facebook.com/groups/aiautomotiveart' },
                    { id: 'recent', label: 'Recent', icon: 'ðŸ•’', angle: 288, distance: 90 }
                ]
            },
            {
                id: 'workshop',
                label: 'Workshop',
                icon: 'ðŸ”¨',
                angle: 318,
                distance: 200,
                submodules: [
                    { id: 'workshop-custom', label: 'Custom Parts', icon: 'âš¡', angle: 0, distance: 90 },
                    { id: 'workshop-livery', label: 'Livery Editor', icon: 'ðŸŽ¨', angle: 120, distance: 90 },
                    { id: 'workshop-share', label: 'Share Designs', icon: 'ðŸ“¤', angle: 240, distance: 90 }
                ]
            }
        ];

        const futureModuleNames = [
            'Rims', 'Fenders', 'Arenas', 'Spoilers', 'Color Maker', 'Taxi Mode', '1v1 Racing', '2v2 Racing',
            'Tag Team', 'King of Hill', 'Domination', 'Search & Destroy', 'Free For All', 'Neon Cars',
            'Comics', 'Paint Booth', 'Tool Maker', 'Exhaust', 'Bumpers', 'Hoods', 'Mirrors', 'Seats',
            'Steering Wheels', 'Dashboards', 'Roll Cages', 'Nitrous', 'Turbo', 'Supercharger', 'ECU Tune',
            'Dyno Testing', 'Track Builder', 'Weather System', 'Day/Night', 'Photo Mode', 'Replay System',
            'Ghost Racing', 'Drift Zones', 'Speed Traps', 'Jump Challenges', 'Stunt Mode', 'Drag Strip',
            'Circuit Racing', 'Rally Mode', 'Off-Road', 'Street Racing', 'Highway Racing', 'Airport',
            'Mountain Pass', 'City Circuit', 'Desert Track', 'Snow Track', 'Rain Racing', 'Fog Racing',
            'Night Racing', 'Sunrise Racing', 'Sunset Racing', 'License Tests', 'Driving School', 'Tutorials',
            'Achievements', 'Trophies', 'Badges', 'Rankings', 'Statistics', 'Lap Records', 'Best Times',
            'Personal Bests', 'Global Records', 'Friend Records', 'Club Racing', 'Team Racing', 'Tournaments',
            'Championships', 'Seasons', 'Weekly Events', 'Daily Challenges', 'Special Events', 'Holiday Events',
            'Car Shows', 'Meet Ups', 'Photo Contests', 'Design Contests', 'Speed Contests', 'Drift Contests',
            'Auction House', 'Trade Center', 'Marketplace', 'Car Dealer', 'Used Cars', 'Classic Cars',
            'Supercars', 'Hypercars', 'Electric Cars', 'Hybrid Cars', 'Muscle Cars', 'JDM Cars', 'Euro Cars',
            'American Cars', 'German Cars', 'Italian Cars', 'Japanese Cars', 'British Cars', 'French Cars',
            'Swedish Cars', 'Korean Cars', 'Concept Cars', 'Prototypes', 'Race Cars', 'Street Cars',
            'Vintage Cars', 'Modern Cars', 'Luxury Cars', 'Sports Cars', 'Coupes', 'Sedans', 'Hatchbacks',
            'Convertibles', 'SUVs', 'Trucks', 'Motorcycles', 'ATVs', 'Boats', 'Planes', 'Helicopters',
            'Damage System', 'Wear & Tear', 'Maintenance', 'Repairs', 'Upgrades', 'Tuning', 'Dyno Charts',
            'Performance', 'Handling', 'Acceleration', 'Top Speed', 'Braking', 'Cornering', 'Stability',
            'Traction', 'Grip', 'Downforce', 'Weight', 'Balance', 'Suspension', 'Alignment', 'Camber',
            'Toe', 'Caster', 'Springs', 'Dampers', 'Anti-Roll', 'Differential', 'Gearing', 'Final Drive'
        ];

        const lockedBubblesData = Array.from({ length: 150 }).map((_, i) => {
            const angle = (i * 2.4); // 150 bubbles spread over 360 degrees
            const distance = 350 + (i % 5) * 20 + Math.random() * 15; // Varying distances
            const nameIndex = i % futureModuleNames.length;
            return {
                id: `locked-${i}`,
                angle: angle,
                distance: distance,
                name: futureModuleNames[nameIndex]
            };
        });

        const updateMessages = [
            'John completed a 1v1 race and earned 500 credits',
            'Sarah unlocked the Drift Master achievement',
            'Mike purchased a new Lamborghini Huracan',
            'Emma customized her car with neon underglow',
            'Alex won the weekly tournament championship',
            'Lisa shared a new livery design',
            'Tom set a new lap record on Tokyo Circuit',
            'Kate joined the AI Automotive Art group',
            'Ryan upgraded his engine to Stage 3',
            'Zoe completed the Career Mode storyline'
        ];

        let currentMessageIndex = 0;

        // 3D Models List - Using the GLB models from your project
        const carModels = [
            { name: 'Fantasy Rally', path: './ASSETS/3D_Models/GLB_Models/Fantasy_Rally_Showdow_0714171004_texture.glb' },
            { name: 'High Octane Drag Racer', path: './ASSETS/3D_Models/GLB_Models/High_Octane_Drag_Rac_0204054716_texture.glb' },
            { name: 'Orange Racer', path: './ASSETS/3D_Models/GLB_Models/Orange_Racer_on_the_R_0714171017_texture.glb' },
            { name: 'Racecar Stanced', path: './ASSETS/3D_Models/GLB_Models/Racecar_stanced_car__0204061642_texture.glb' },
            { name: 'Red Elegance', path: './ASSETS/3D_Models/GLB_Models/Red_Elegance_on_the_B_0603082717_texture.glb' },
            { name: 'Speed Aesthetic', path: './ASSETS/3D_Models/GLB_Models/Speed_Aesthetic_0714170948_texture.glb' },
            { name: 'Model 1', path: './ASSETS/3D_Models/GLB_Models/model.glb' },
            { name: 'Model 2', path: './ASSETS/3D_Models/GLB_Models/model (1).glb' },
            { name: 'Model 3', path: './ASSETS/3D_Models/GLB_Models/model (2).glb' },
            { name: 'Model 4', path: './ASSETS/3D_Models/GLB_Models/model (3).glb' },
            { name: 'Model 5', path: './ASSETS/3D_Models/GLB_Models/model (4).glb' },
            { name: 'Model 6', path: './ASSETS/3D_Models/GLB_Models/model (5).glb' },
            { name: 'Sample 1', path: './ASSETS/3D_Models/GLB_Models/sample.glb' },
            { name: 'Sample 2', path: './ASSETS/3D_Models/GLB_Models/sample (1).glb' },
            { name: 'Sample 3', path: './ASSETS/3D_Models/GLB_Models/sample (2).glb' },
            { name: 'Sample 4', path: './ASSETS/3D_Models/GLB_Models/sample (3).glb' },
            { name: 'Sample 5', path: './ASSETS/3D_Models/GLB_Models/sample (4).glb' },
            { name: 'Sample 6', path: './ASSETS/3D_Models/GLB_Models/sample (5).glb' },
            { name: 'White Mesh', path: './ASSETS/3D_Models/GLB_Models/white_mesh.glb' },
            { name: 'Base Model', path: './ASSETS/3D_Models/GLB_Models/0.glb' }
        ];

        let currentModelIndex = 0;
        let scene, camera, renderer, controls;
        let currentModel = null;

        // --- RENDER FUNCTION ---
        function renderApp() {
            const root = document.getElementById('app-root');
            root.innerHTML = '';

            const mainContainer = document.createElement('div');
            mainContainer.className = "w-screen h-screen bg-cover bg-center";
            mainContainer.style.backgroundImage = `url('${backgroundImage}')`;

            // Create header
            const header = document.createElement('div');
            header.className = "absolute top-0 left-0 w-full h-12 bg-[#0a1423]/90 backdrop-blur-md border-b border-cyan-400/20 flex items-center justify-between px-6 z-50";

            // Time display
            const timeDisplay = document.createElement('div');
            timeDisplay.className = "text-cyan-200 text-sm font-bold";
            const now = new Date();
            timeDisplay.textContent = now.toLocaleTimeString('en-US', { hour12: false });
            header.appendChild(timeDisplay);

            // Profile section
            const profileSection = document.createElement('div');
            profileSection.className = "flex items-center gap-4";

            const profileContainer = document.createElement('div');
            profileContainer.className = "relative";

            const profilePic = document.createElement('div');
            profilePic.className = "w-8 h-8 rounded-full bg-gradient-to-r from-cyan-400 to-blue-500 flex items-center justify-center cursor-pointer transition-all duration-300 hover:scale-110 hover:shadow-lg hover:shadow-cyan-400/50";
            profilePic.innerHTML = '<span class="text-white text-xs font-bold">P</span>';

            // Create dropdown menu
            const profileMenu = document.createElement('div');
            profileMenu.className = "absolute top-full right-0 mt-2 w-32 bg-[#0a1423]/95 backdrop-blur-md border border-cyan-400/30 rounded-lg shadow-lg shadow-cyan-400/20 opacity-0 pointer-events-none transition-all duration-300 z-50";

            const menuItems = [
                { label: 'Home', icon: 'ðŸ ' },
                { label: 'My Car', icon: 'ðŸŽï¸', url: 'my-car.html' },
                { label: 'Garage', icon: 'ðŸš—' },
                { label: 'World', icon: 'ðŸŒ' }
            ];

            menuItems.forEach((item, index) => {
                const menuItem = document.createElement('div');
                menuItem.className = "flex items-center gap-2 px-3 py-2 text-cyan-200 text-xs cursor-pointer hover:bg-cyan-400/10 hover:text-cyan-100 transition-colors duration-200";
                if (index === 0) menuItem.className += " rounded-t-lg";
                if (index === menuItems.length - 1) menuItem.className += " rounded-b-lg";

                menuItem.innerHTML = `<span>${item.icon}</span><span>${item.label}</span>`;

                menuItem.addEventListener('click', () => {
                    console.log(`Navigating to ${item.label}`);
                    if (item.url) {
                        window.location.href = item.url;
                    } else {
                        console.log(`${item.label} functionality coming soon`);
                    }
                    profileMenu.style.opacity = '0';
                    profileMenu.style.pointerEvents = 'none';
                });

                profileMenu.appendChild(menuItem);
            });

            // Click event to show menu in main window
            profilePic.addEventListener('click', () => {
                showProfileMenu();
            });

            profileContainer.appendChild(profilePic);
            profileContainer.appendChild(profileMenu);

            const friendsOnline = document.createElement('div');
            friendsOnline.className = "text-cyan-200 text-xs";
            friendsOnline.innerHTML = 'ðŸŸ¢ <span class="font-bold">23</span> friends online';

            profileSection.appendChild(profileContainer);
            profileSection.appendChild(friendsOnline);
            header.appendChild(profileSection);

            // Scrolling updates section
            const updatesContainer = document.createElement('div');
            updatesContainer.className = "flex-1 mx-6 overflow-hidden relative h-full";

            const updatesText = document.createElement('div');
            updatesText.className = "absolute top-1/2 transform -translate-y-1/2 text-cyan-300/80 text-xs whitespace-nowrap animate-scroll-left";
            updatesText.textContent = updateMessages[currentMessageIndex % updateMessages.length];

            updatesContainer.appendChild(updatesText);
            header.appendChild(updatesContainer);

            mainContainer.appendChild(header);

            const overlay = document.createElement('div');
            overlay.className = "w-full h-full bg-[#0a1423]/80 backdrop-blur-sm flex items-center justify-center overflow-hidden pt-12";
            mainContainer.appendChild(overlay);

            const hubContainer = document.createElement('div');
            hubContainer.className = "relative w-[800px] h-[800px] flex items-center justify-center";
            hubContainer.addEventListener('mouseleave', () => {
                activeBubbleId = null;
                activeSubBubbleId = null;
                renderApp();
            });
            overlay.appendChild(hubContainer);

            const centralHub = document.createElement('div');
            centralHub.className = "w-80 h-80 bg-[#101a2c] rounded-full shadow-2xl shadow-cyan-500/10 border-2 border-cyan-400/20 bg-cover bg-center relative overflow-hidden";
            centralHub.style.backgroundImage = `url(${currentCarImage})`;

            const carOverlay = document.createElement('div');
            carOverlay.className = "absolute inset-0 bg-gradient-to-t from-[#101a2c]/80 via-transparent to-transparent flex items-end justify-center pb-4";
            carOverlay.innerHTML = '<div class="text-cyan-200 text-sm font-bold">Current Car</div>';
            centralHub.appendChild(carOverlay);

            hubContainer.appendChild(centralHub);

            const ring1 = document.createElement('div');
            ring1.className = "absolute w-[550px] h-[550px] border-2 border-cyan-400/10 rounded-full animate-pulse-slow";
            hubContainer.appendChild(ring1);

            const ring2 = document.createElement('div');
            ring2.className = "absolute w-[700px] h-[700px] border border-cyan-400/5 rounded-full animate-pulse-slower";
            hubContainer.appendChild(ring2);

            bubblesData.forEach(data => {
                const isActive = activeBubbleId === data.id;
                const bubble = createBubble(data, isActive);
                bubble.addEventListener('mouseenter', () => {
                    activeBubbleId = data.id;
                    activeSubBubbleId = null;
                    renderApp();
                });
                hubContainer.appendChild(bubble);
            });

            const activeBubbleData = bubblesData.find(b => b.id === activeBubbleId);
            if (activeBubbleData && activeBubbleData.submodules) {
                activeBubbleData.submodules.forEach(subData => {
                    const subBubble = createSubBubble(subData, activeBubbleData);
                    subBubble.addEventListener('mouseenter', () => {
                         activeSubBubbleId = subData.id;
                         renderApp();
                    });
                    hubContainer.appendChild(subBubble);
                });
            }

            const activeSubBubbleData = activeBubbleData?.submodules?.find(sb => sb.id === activeSubBubbleId);
             if (activeSubBubbleData && activeSubBubbleData.submodules) {
                activeSubBubbleData.submodules.forEach(subSubData => {
                    const subSubBubble = createSubSubBubble(subSubData, activeSubBubbleData, activeBubbleData);
                    hubContainer.appendChild(subSubBubble);
                });
            }

            lockedBubblesData.forEach(data => {
                hubContainer.appendChild(createLockedBubble(data));
            });

            // Create 3D Viewer Modal
            const viewer3DModal = document.createElement('div');
            viewer3DModal.id = 'viewer3d';
            viewer3DModal.className = 'fixed inset-0 bg-black/80 modal-backdrop z-[100] flex items-center justify-center';

            const viewerContainer = document.createElement('div');
            viewerContainer.className = 'bg-[#0a1423]/95 backdrop-blur-md border border-cyan-400/30 rounded-xl p-6 w-[90vw] h-[80vh] relative';

            // Close button
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = 'âœ•';
            closeBtn.className = 'absolute top-4 right-4 text-cyan-200 hover:text-white text-2xl z-10';
            closeBtn.addEventListener('click', close3DViewer);

            // Model selector
            const modelSelector = document.createElement('div');
            modelSelector.className = 'flex items-center gap-4 mb-4';

            const prevBtn = document.createElement('button');
            prevBtn.innerHTML = 'â—€';
            prevBtn.className = 'px-3 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded transition-colors';
            prevBtn.addEventListener('click', previousModel);

            const modelName = document.createElement('div');
            modelName.id = 'current-model-name';
            modelName.className = 'text-cyan-200 font-bold flex-1 text-center';
            modelName.textContent = carModels[currentModelIndex].name;

            const nextBtn = document.createElement('button');
            nextBtn.innerHTML = 'â–¶';
            nextBtn.className = 'px-3 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded transition-colors';
            nextBtn.addEventListener('click', nextModel);

            modelSelector.appendChild(prevBtn);
            modelSelector.appendChild(modelName);
            modelSelector.appendChild(nextBtn);

            // 3D Canvas
            const canvas3D = document.createElement('canvas');
            canvas3D.id = 'canvas3d';
            canvas3D.className = 'w-full h-full rounded-lg';

            viewerContainer.appendChild(closeBtn);
            viewerContainer.appendChild(modelSelector);
            viewerContainer.appendChild(canvas3D);
            viewer3DModal.appendChild(viewerContainer);

            // Create Profile Menu Modal
            const profileMenuModal = document.createElement('div');
            profileMenuModal.id = 'profile-menu-modal';
            profileMenuModal.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm z-[90] flex items-center justify-center hidden';

            const profileMenuContainer = document.createElement('div');
            profileMenuContainer.className = 'bg-[#0a1423]/95 backdrop-blur-md border border-cyan-400/30 rounded-xl p-8 w-[400px] relative';

            // Close button
            const closeProfileBtn = document.createElement('button');
            closeProfileBtn.innerHTML = 'âœ•';
            closeProfileBtn.className = 'absolute top-4 right-4 text-cyan-200 hover:text-white text-xl';
            closeProfileBtn.addEventListener('click', hideProfileMenu);

            // Profile header
            const profileHeader = document.createElement('div');
            profileHeader.className = 'text-center mb-6';
            profileHeader.innerHTML = `
                <div class="w-16 h-16 rounded-full bg-gradient-to-r from-cyan-400 to-blue-500 flex items-center justify-center mx-auto mb-4">
                    <span class="text-white text-2xl font-bold">P</span>
                </div>
                <h3 class="text-cyan-200 text-xl font-bold">Player Profile</h3>
                <p class="text-gray-400 text-sm">Choose your destination</p>
            `;

            // Menu items
            const profileMenuItems = document.createElement('div');
            profileMenuItems.className = 'space-y-3';

            const menuOptions = [
                { label: 'Home', icon: 'ðŸ ', description: 'Return to main hub' },
                { label: 'My Car', icon: 'ðŸŽï¸', url: 'my-car.html', description: 'View your car\'s live history' },
                { label: 'Garage', icon: 'ðŸš—', description: 'Customize your vehicles' },
                { label: 'World', icon: 'ðŸŒ', description: 'Open world driving mode' }
            ];

            menuOptions.forEach(option => {
                const menuButton = document.createElement('button');
                menuButton.className = 'w-full flex items-center gap-4 p-4 bg-[#1a2332] hover:bg-cyan-400/10 rounded-lg border border-transparent hover:border-cyan-400/30 transition-all duration-200 text-left';
                menuButton.innerHTML = `
                    <div class="text-3xl">${option.icon}</div>
                    <div class="flex-1">
                        <div class="text-cyan-200 font-semibold">${option.label}</div>
                        <div class="text-gray-400 text-sm">${option.description}</div>
                    </div>
                    <div class="text-cyan-400">â†’</div>
                `;

                menuButton.addEventListener('click', () => {
                    if (option.url) {
                        window.location.href = option.url;
                    } else {
                        console.log(`${option.label} functionality coming soon`);
                        hideProfileMenu();
                    }
                });

                profileMenuItems.appendChild(menuButton);
            });

            profileMenuContainer.appendChild(closeProfileBtn);
            profileMenuContainer.appendChild(profileHeader);
            profileMenuContainer.appendChild(profileMenuItems);
            profileMenuModal.appendChild(profileMenuContainer);

            root.appendChild(mainContainer);
            root.appendChild(viewer3DModal);
            root.appendChild(profileMenuModal);
        }

        function createBubble(data, isActive) {
            const { icon, label, angle, distance } = data;
            const radians = angle * (Math.PI / 180);
            const x = distance * Math.cos(radians);
            const y = distance * Math.sin(radians);

            const el = document.createElement('div');
            el.className = `absolute flex flex-col items-center justify-center w-10 h-10 rounded-full cursor-pointer transition-all duration-700 ease-out transform hover:scale-110`;
            el.style.transform = `translate(${x}px, ${y}px) ${isActive ? 'scale(1.15)' : 'scale(1)'}`;
            el.style.backgroundColor = isActive ? 'rgba(0, 255, 255, 0.2)' : 'rgba(16, 40, 60, 0.7)';
            el.style.border = `2px solid ${isActive ? 'rgba(255, 255, 0, 1)' : 'rgba(0, 255, 255, 0.3)'}`;
            el.style.boxShadow = isActive ? '0 0 30px rgba(255, 255, 0, 0.8), 0 0 60px rgba(255, 255, 0, 0.4)' : 'none';
            el.innerHTML = `<span class="text-lg">${icon}</span><span class="text-[8px] text-cyan-200">${label}</span>`;

            // Add click glow effect
            el.addEventListener('click', (e) => {
                triggerClickGlow(el);
            });

            return el;
        }

        function createSubBubble(data, parent) {
            const { icon, label, angle, distance, url } = data;
            const parentRadians = parent.angle * (Math.PI / 180);
            const parentX = parent.distance * Math.cos(parentRadians);
            const parentY = parent.distance * Math.sin(parentRadians);
            const radians = angle * (Math.PI / 180);
            const x = parentX + distance * Math.cos(radians);
            const y = parentY + distance * Math.sin(radians);

            const el = document.createElement('div');
            el.className = `absolute flex flex-col items-center justify-center w-16 h-16 rounded-full cursor-pointer transition-all duration-300 ease-in-out transform hover:scale-110`;
            el.style.transform = `translate(${x}px, ${y}px)`;
            el.style.backgroundColor = url ? 'rgba(59, 89, 152, 0.8)' : 'rgba(20, 50, 70, 0.8)';
            el.style.border = url ? '1px solid rgba(59, 89, 152, 0.8)' : '1px solid rgba(0, 255, 255, 0.4)';
            el.innerHTML = `<span class="text-2xl">${icon}</span><span class="text-[10px] text-cyan-100 text-center leading-tight">${label}</span>`;

            // Add single click handler for all sub-bubbles
            el.addEventListener('click', (e) => {
                e.stopPropagation();
                triggerClickGlow(el);

                // Handle URL bubbles (like Facebook group)
                if (url) {
                    window.open(url, '_blank');
                } else {
                    // Handle regular sub-bubble functions
                    handleSubBubbleClick(data.id, parent.id);
                }
            });

            // Special styling
            if (url) {
                el.style.boxShadow = '0 0 10px rgba(59, 89, 152, 0.3)';
            } else if (data.id === '3d-viewer') {
                el.style.boxShadow = '0 0 10px rgba(255, 255, 0, 0.3)';
            }

            return el;
        }

        function createSubSubBubble(data, parent, grandparent) {
             const { icon, label, angle, distance } = data;
             const gpRadians = grandparent.angle * (Math.PI / 180);
             const gpX = grandparent.distance * Math.cos(gpRadians);
             const gpY = grandparent.distance * Math.sin(gpRadians);
             const pRadians = parent.angle * (Math.PI / 180);
             const pX = gpX + parent.distance * Math.cos(pRadians);
             const pY = gpY + parent.distance * Math.sin(pRadians);
             const radians = angle * (Math.PI / 180);
             const x = pX + distance * Math.cos(radians);
             const y = pY + distance * Math.sin(radians);
             const el = document.createElement('div');
             el.className = `absolute flex flex-col items-center justify-center w-14 h-14 rounded-full cursor-pointer transition-all duration-200 ease-in-out transform hover:scale-110`;
             el.style.transform = `translate(${x}px, ${y}px)`;
             el.style.backgroundColor = 'rgba(30, 60, 80, 0.9)';
             el.style.border = `1px solid rgba(0, 255, 255, 0.3)`;
             el.innerHTML = `<span class="text-xl">${icon}</span><span class="text-[9px] text-cyan-200 text-center leading-tight">${label}</span>`;

             // Add click glow effect and functionality for sub-sub-bubbles
             el.addEventListener('click', (e) => {
                 e.stopPropagation();
                 triggerClickGlow(el);
                 handleSubSubBubbleClick(data.id, parent.id, grandparent.id);
             });

             return el;
        }

        function createLockedBubble(data) {
            const { angle, distance, name } = data;
            const radians = angle * (Math.PI / 180);
            const x = distance * Math.cos(radians);
            const y = distance * Math.sin(radians);

            const el = document.createElement('div');
            el.className = `absolute flex items-center justify-center w-6 h-6 rounded-full bg-gray-800/70 border border-gray-600/60 cursor-pointer transition-all duration-200 hover:scale-125 hover:bg-gray-700/80 hover:border-gray-500`;
            el.style.transform = `translate(${x}px, ${y}px)`;
            el.innerHTML = `<span class="text-gray-400 text-xs">ðŸ”’</span>`;

            // Create tooltip
            const tooltip = document.createElement('div');
            tooltip.className = `absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 bg-gray-900/90 text-cyan-200 text-xs rounded border border-cyan-400/30 whitespace-nowrap opacity-0 pointer-events-none transition-opacity duration-200 z-50`;
            tooltip.textContent = `${name} (Locked)`;
            el.appendChild(tooltip);

            // Hover events
            el.addEventListener('mouseenter', () => {
                tooltip.style.opacity = '1';
            });
            el.addEventListener('mouseleave', () => {
                tooltip.style.opacity = '0';
            });

            // Add click glow effect for locked bubbles
            el.addEventListener('click', (e) => {
                triggerClickGlow(el);
                // Could add "Coming Soon" message or unlock animation here
            });

            return el;
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderApp();

            // Update time every second
            setInterval(() => {
                const timeElement = document.querySelector('.text-cyan-200.text-sm.font-bold');
                if (timeElement) {
                    const now = new Date();
                    timeElement.textContent = now.toLocaleTimeString('en-US', { hour12: false });
                }
            }, 1000);

            // Cycle through update messages every 15 seconds (matches animation duration)
            setInterval(() => {
                currentMessageIndex++;
                const updatesElement = document.querySelector('.animate-scroll-left');
                if (updatesElement) {
                    updatesElement.textContent = updateMessages[currentMessageIndex % updateMessages.length];
                }
            }, 15000);
        });

        // 3D Viewer Functions
        function open3DViewer() {
            console.log('Opening 3D viewer...');
            const modal = document.getElementById('viewer3d');
            if (!modal) {
                console.error('3D viewer modal not found');
                return;
            }
            modal.style.display = 'flex';

            // Check if Three.js is loaded
            if (typeof THREE === 'undefined') {
                console.error('Three.js not loaded');
                alert('3D viewer libraries not loaded. Please refresh the page.');
                return;
            }

            init3DViewer();
            loadModel(carModels[currentModelIndex].path);
        }

        function close3DViewer() {
            const modal = document.getElementById('viewer3d');
            modal.style.display = 'none';
            if (renderer) {
                renderer.dispose();
            }
        }

        function init3DViewer() {
            const canvas = document.getElementById('canvas3d');
            const container = canvas.parentElement;
            const rect = container.getBoundingClientRect();

            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a1423);

            // Camera
            camera = new THREE.PerspectiveCamera(75, rect.width / rect.height, 0.1, 1000);
            camera.position.set(0, 2, 5);

            // Renderer
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            renderer.setSize(rect.width - 50, rect.height - 100);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;

            // Lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 10, 5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);

            // Controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            // Start render loop
            animate();
        }

        function loadModel(modelPath) {
            if (currentModel) {
                scene.remove(currentModel);
            }

            const loader = new THREE.GLTFLoader();
            loader.load(
                modelPath,
                function(gltf) {
                    currentModel = gltf.scene;

                    // Center and scale the model
                    const box = new THREE.Box3().setFromObject(currentModel);
                    const center = box.getCenter(new THREE.Vector3());
                    const size = box.getSize(new THREE.Vector3());

                    const maxAxis = Math.max(size.x, size.y, size.z);
                    currentModel.scale.setScalar(2 / maxAxis);
                    currentModel.position.copy(center).multiplyScalar(-1);

                    scene.add(currentModel);
                },
                function(progress) {
                    console.log('Loading progress:', (progress.loaded / progress.total * 100) + '%');
                },
                function(error) {
                    console.error('Error loading model:', error);
                    // Try alternative path structure
                    const altPath = modelPath.replace('./ASSETS/', './ACTIVE_PROJECTS/Car_Viewer_Simple/models/');
                    if (altPath !== modelPath) {
                        loadModel(altPath.replace('GLB_Models/', ''));
                    }
                }
            );
        }

        function previousModel() {
            currentModelIndex = (currentModelIndex - 1 + carModels.length) % carModels.length;
            updateModelDisplay();
        }

        function nextModel() {
            currentModelIndex = (currentModelIndex + 1) % carModels.length;
            updateModelDisplay();
        }

        function updateModelDisplay() {
            document.getElementById('current-model-name').textContent = carModels[currentModelIndex].name;
            loadModel(carModels[currentModelIndex].path);
        }

        function animate() {
            requestAnimationFrame(animate);
            if (controls) controls.update();
            if (renderer && scene && camera) renderer.render(scene, camera);
        }

        // Click glow effect function
        function triggerClickGlow(element) {
            element.classList.remove('click-glow');
            // Force reflow to restart animation
            void element.offsetWidth;
            element.classList.add('click-glow');

            // Remove class after animation completes
            setTimeout(() => {
                element.classList.remove('click-glow');
            }, 300);
        }

        // Profile menu functions
        function showProfileMenu() {
            const modal = document.getElementById('profile-menu-modal');
            if (modal) {
                modal.style.display = 'flex';
                modal.classList.remove('hidden');
            }
        }

        function hideProfileMenu() {
            const modal = document.getElementById('profile-menu-modal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.add('hidden');
            }
        }

        // Sub-bubble click handler function
        function handleSubBubbleClick(subBubbleId, parentId) {
            console.log(`Clicked ${subBubbleId} in ${parentId}`);

            switch(parentId) {
                case 'market':
                    handleMarketFunction(subBubbleId);
                    break;
                case 'race':
                    handleRaceFunction(subBubbleId);
                    break;
                case 'career':
                    handleCareerFunction(subBubbleId);
                    break;
                case 'events':
                    handleEventsFunction(subBubbleId);
                    break;
                case 'options':
                    handleOptionsFunction(subBubbleId);
                    break;
                case 'tune':
                    handleTuneFunction(subBubbleId);
                    break;
                case 'garage':
                    handleGarageFunction(subBubbleId);
                    break;
                case 'social':
                    handleSocialFunction(subBubbleId);
                    break;
                case 'workshop':
                    handleWorkshopFunction(subBubbleId);
                    break;
                default:
                    console.log(`No handler for ${parentId}`);
            }
        }

        // Market functions
        function handleMarketFunction(subId) {
            switch(subId) {
                case 'used':
                    showModal('Used Car Market', 'Browse pre-owned vehicles from other players. Filter by price, mileage, and condition.');
                    break;
                case 'new-cars':
                    showModal('New Car Dealership', 'Purchase brand new vehicles from manufacturers. Latest models with full warranty.');
                    break;
                case 'dealership':
                    showModal('Premium Dealership', 'Exclusive access to rare and luxury vehicles. Special financing available.');
                    break;
            }
        }

        // Race functions
        function handleRaceFunction(subId) {
            switch(subId) {
                case 'race-quick':
                    showModal('Quick Race', 'Jump into instant racing action. Choose your car and hit the track!',
                        '<button class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-white">Start Race</button>');
                    break;
                case 'race-champ':
                    showModal('Championship Mode', 'Compete in structured tournament series. Win prizes and climb rankings!');
                    break;
                case 'race-online':
                    showModal('Online Racing', 'Race against players worldwide. Join lobbies or create your own room.');
                    break;
                case 'race-time':
                    showModal('Time Trial', 'Test your skills against the clock. Set new personal and global records.');
                    break;
                case 'race-drift':
                    showModal('Drift Mode', 'Master the art of drifting. Score points with style and precision.');
                    break;
            }
        }

        // Career functions
        function handleCareerFunction(subId) {
            switch(subId) {
                case 'career-story':
                    showModal('Story Mode', 'Follow your racing journey from rookie to champion. Unlock new areas and storylines.');
                    break;
                case 'career-challenges':
                    showModal('Racing Challenges', 'Complete specific objectives to earn rewards and unlock special content.');
                    break;
                case 'career-progress':
                    showModal('Career Progress', 'View your racing statistics, achievements, and overall progression through the career.');
                    break;
            }
        }

        // Events functions
        function handleEventsFunction(subId) {
            switch(subId) {
                case 'events-special':
                    showModal('Special Events', 'Limited-time events with unique rewards. Check back regularly for new challenges!');
                    break;
                case 'events-community':
                    showModal('Community Events', 'Player-created and community-driven events. Join the racing community!');
                    break;
                case 'events-boards':
                    showModal('Leaderboards', 'See how you rank against other players in various racing categories.');
                    break;
            }
        }

        // Options functions
        function handleOptionsFunction(subId) {
            switch(subId) {
                case 'options-graphics':
                    showModal('Graphics Settings', 'Adjust visual quality, resolution, and rendering options for optimal performance.');
                    break;
                case 'options-audio':
                    showModal('Audio Settings', 'Configure sound effects, music volume, and audio output preferences.');
                    break;
                case 'options-controls':
                    showModal('Control Settings', 'Customize keyboard, mouse, and gamepad controls to your preference.');
                    break;
                case 'options-gameplay':
                    showModal('Gameplay Settings', 'Adjust difficulty, assist options, and gameplay mechanics.');
                    break;
            }
        }

        // Tune functions
        function handleTuneFunction(subId) {
            switch(subId) {
                case 'tune-engine':
                    showModal('Engine Tuning', 'Modify engine performance: turbo, ECU mapping, air intake, and exhaust systems.');
                    break;
                case 'tune-suspension':
                    showModal('Suspension Setup', 'Adjust ride height, spring rates, dampers, and anti-roll bars for handling.');
                    break;
                case 'tune-tires':
                    showModal('Tire Configuration', 'Select tire compounds and adjust pressure for different track conditions.');
                    break;
                case 'tune-ecu':
                    showModal('ECU Programming', 'Fine-tune engine management systems for maximum performance and efficiency.');
                    break;
            }
        }

        // Garage functions
        function handleGarageFunction(subId) {
            switch(subId) {
                case 'paint':
                    showModal('Paint Shop', 'Customize your car\'s appearance with colors, patterns, and special finishes.');
                    break;
                case 'edit-parts':
                    showModal('Parts Editor', 'Install and configure aftermarket parts to enhance performance and appearance.');
                    break;
                case 'parts':
                    showModal('Parts Inventory', 'Browse and manage your collection of car parts and upgrade components.');
                    break;
                case '3d-viewer':
                    open3DViewer();
                    break;
                case 'view-all':
                    showModal('Car Collection', 'Browse all vehicles in your garage. Select different cars for racing.');
                    break;
                case 'view-specific':
                    showModal('Car Inspector', 'Detailed view of your selected vehicle with stats and modification history.');
                    break;
            }
        }

        // Social functions
        function handleSocialFunction(subId) {
            switch(subId) {
                case 'profile':
                    showModal('My Profile', 'View and edit your racing profile, achievements, and personal statistics.');
                    break;
                case 'search':
                    showModal('Player Search', 'Find other racers by username, view their profiles and racing history.');
                    break;
                case 'friends':
                    showModal('Friends List', 'Manage your friends list, send challenges, and view friend activities.');
                    break;
                case 'recent':
                    showModal('Recent Activity', 'See recent races, achievements, and interactions with other players.');
                    break;
            }
        }

        // Workshop functions
        function handleWorkshopFunction(subId) {
            switch(subId) {
                case 'workshop-custom':
                    showModal('Custom Parts', 'Create and modify custom car parts using advanced design tools.');
                    break;
                case 'workshop-livery':
                    showModal('Livery Editor', 'Design custom paint schemes and decals for your vehicles.');
                    break;
                case 'workshop-share':
                    showModal('Share Designs', 'Upload your creations and download designs from other players.');
                    break;
            }
        }

        // Sub-sub-bubble click handler function
        function handleSubSubBubbleClick(subSubBubbleId, subBubbleId, parentId) {
            console.log(`Clicked ${subSubBubbleId} in ${subBubbleId} of ${parentId}`);

            // Handle Market > Used sub-modules
            if (parentId === 'market' && subBubbleId === 'used') {
                switch(subSubBubbleId) {
                    case 'auction':
                        showModal('Car Auction', 'Bid on rare and exclusive vehicles from other players. Live bidding system with real-time updates.',
                            '<button class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-white">View Auctions</button>');
                        break;
                    case 'marketplace':
                        showModal('Marketplace', 'Buy and sell vehicles instantly at fixed prices. Browse listings or post your own cars for sale.',
                            '<button class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-white">Browse Market</button>');
                        break;
                }
            }
        }

        // Modal system for sub-bubble functions
        function showModal(title, description, extraContent = '') {
            // Remove existing modals
            const existingModal = document.getElementById('function-modal');
            if (existingModal) existingModal.remove();

            const modal = document.createElement('div');
            modal.id = 'function-modal';
            modal.className = 'fixed inset-0 bg-black/70 backdrop-blur-sm z-[95] flex items-center justify-center';

            const modalContent = document.createElement('div');
            modalContent.className = 'bg-[#0a1423]/95 backdrop-blur-md border border-cyan-400/30 rounded-xl p-6 max-w-md w-full mx-4 relative';

            modalContent.innerHTML = `
                <button onclick="document.getElementById('function-modal').remove()"
                        class="absolute top-4 right-4 text-cyan-200 hover:text-white text-xl">âœ•</button>
                <h3 class="text-cyan-200 text-xl font-bold mb-4">${title}</h3>
                <p class="text-gray-300 text-sm mb-6">${description}</p>
                <div class="flex gap-3">
                    ${extraContent}
                    <button onclick="document.getElementById('function-modal').remove()"
                            class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded text-white">Close</button>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Close on backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }
    </script>
</body>
</html>